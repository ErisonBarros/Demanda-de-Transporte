---
title: "Multiple Linear Regression"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
**INSTITUTO SUPERIOR TECNICO, UNIVERSITY OF LISBON**  
![](https://media-exp1.licdn.com/dms/image/C560BAQG-Q7His3Mn4w/company-logo_200_200/0?e=1612396800&v=beta&t=7e2u0RwGubqElKFquvKKot2g3Y6EPjXoXDBByKZvvUs)
**TRANSPORT DEMAND MODELLING COURSE, PROF. FILIPE MOURA**  
**Prepared by [Gabriel ValenÃ§a](https://ushift.tecnico.ulisboa.pt/team-gabriel-valenca/), PhD Candidate** 

## Chicago example exercise

Trip production of 57 Traffic Assignment Zones of Chicago in 1960's

> Your task: Estimate a linear regression model that predicts trips per occupied dwelling unit.  

### Variables:

* `TODU`: Motorized Trips (private car or Public Transportation) per occupied dwelling unit;
* ACO: Average car ownership (cars per dwelling);
* AHS: Average household size;
* SRI: Social Rank Index:  
      1. proportion of blue-collar workers (e.g., construction, mining);  
      2. proportion of people with age higher than 25 years that have completed at least 8 year of education;  
> **Note:** The SRI has its maximum value when there are no blue-collar workers and all adults have education of at least 8 years. 

> UI: Urbanization Index:
1. fertility rate, defined as the ratio of children under 5 years of age to  the female population of childbearing age;  
2. female labor force participation rate, meaning the % of women who are in the labor force;  
3. % of single family units to total dwelling units.

      ## The degree of urbanization index would be increased by
        ### a) lower fertility rate,
        ### b) higher female labor force participation rate, and
        ### c) higher proportion of single dwelling units.

      ## Note: High values for this index imply less attachment to the home

SI:Segregation Index
      ## It measures the proportion of an area to which minority groups
      ## (e.g: non-whites, foreign-born, Eastern Europeans) live in isolation.
      
      ## Note: High values for this index imply that those communities are less
      ## prone to leaving their living areas and as such to having lower
      ## levels of mobility.



### Import Libraries
Let's begin!

For the first time, you will need to install some of the packages. 
Step by step: 

  1. Go to Packages on the lower right display window and click install
  2. write the library you want to install and click "install"
  
Or... `install.packages("readxl","tidyverse")` etc...



```{r message=FALSE, warning=FALSE, paged.print=TRUE}
library(readxl) #Library used to import excel files
library(tidyverse) # Library used in data science to perform exploratory data analysis
library(skimr) # Library used for providing a summary of the data
library(DataExplorer) # Library used in data science to perform exploratory data analysis
library(corrplot) # Library used for correlation plots
library(car) # Library used for testing autocorrelation (Durbin Watson)
library(olsrr) # Library used for testing multicollinearity (VIF, TOL, etc.)
```

### EXPLORATORY DATA ANALYSIS (EDA)

##### Import dataset

```{r}
dataset <- read_excel("Data/TDM_Class3_MLR_Chicago_Example.xls") 
```

##### Check the structure of the dataset 
```{r}
str(dataset)
```

##### Take a first look at the dataset

```{r paged.print=TRUE}
head(dataset, 10)
```

##### Check the type and class of the dataset

```{r echo=TRUE, eval=FALSE} 
#este apenas mostra o codigo, o seguinte apenas mostra os outputs
typeof(dataset)
class(dataset)
```

```{r echo=FALSE}
typeof(dataset)
class(dataset)
```

##### Transform dataset into dataframe

```{r}
df <- data.frame(dataset)
```

##### Compare the structure of the dataset with df

```{r}
str(dataset)
str(df)
```

> **Note:** The dataframe function transforms columns into variables and rows into observations. 

##### Take a look at the dataframe

```{r}
head(df, 10)
```

##### Show summary statistics
 
```{r}
skim(df)
```

##### Check missing data

```{r}
plot_missing(df)
```

# Create a separate bar plot for each variable, demonstrating the distributions of all continuous variables
plot_histogram(df)

# Plot boxplots of each independent variable with TODU

plot_boxplot(df, by = "TODU")

# Plot correlation heatmaps

res1 <- cor.mtest(df, conf.level = .95)

corrplot(cor(df), p.mat = res1$p, method = "number", type = "upper", order="hclust", sig.level = 0.05)

## Note: try putting into method "color" or "circle", and see the diference.

## Note: The pairwise correlations that are crossed are statistically insignificant. 
## This means that pvalue > 0.05, and you should not reject the null hypothesis.
## The null hypothesis is that correlation is zero.

# Therefore, take a look at this example and see for yourself: 

cor.test(df$AHS, df$SI)

# MULTIPLE LINEAR REGRESSION
# Task: Estimate a linear regression model that predicts trips per occupied dwelling unit.
# y(TODU) = bo + b1*ACO + b2*AHS + b3*SI + b4*SRI +b5*UI + Error

## Before running the model, you need to check if the requirements are met. 
## For instance, let's take a look if the independent variables have linear relation with the dependent variables.

plot(x = df$TODU, y = df$ACO, xlab = "TODU", ylab = "ACO")
plot(x = df$TODU, y = df$AHS, xlab = "TODU", ylab = "AHS")
plot(x = df$TODU, y = df$SI, xlab = "TODU", ylab = "SI")
plot(x = df$TODU, y = df$SRI, xlab = "TODU", ylab = "SRI")
plot(x = df$TODU, y = df$UI, xlab = "TODU", ylab = "UI")

# Or you could execute a pairwise scatterplot matrix, that compares every variable with each other: 

pairs(df[,1:6], pch = 19, lower.panel = NULL)

# Check if the Dependent variable is normally distributed

## If sample is smaller than 2000 observations, use Shapiro-Wilk test: 
shapiro.test(df$TODU)

# If not, use the Kolmogorov-Smirnov test
ks.test(df$TODU, "pnorm", mean=mean(df$TODU), sd = sd(df$TODU))

# Note the warning that appears in the Kolmogorov-Smirnov test:
# "ties should not be present for the Kolmogorov-Smirnov test".

# Most likely what happened is that this test only works with continuous variables.
# Although TODU is a countinuous variable, the small sample size, makes it likely to have repeated values.
# Consequently, the test considers TODU as categorical variable. Therefore, this is another evidence,
# that for small samples it is more appropriate to use the Shapiro Test.


# Finally, let's run the multiple linear regression model!

model <- lm(TODU ~ ACO + AHS + SI + SRI + UI, data = df)
summary(model)
plot(model)

# Execute the Durbin Watson test to evaluate autocorrelation of the residuals

durbinWatsonTest(model)

# To calculate the VIF and TOL to test multicollinearity
ols_vif_tol(model)

To calculate the Condition Index to test multicollinearity
ols_eigen_cindex(model)

To test both simultaneously
ols_coll_diag(model)





